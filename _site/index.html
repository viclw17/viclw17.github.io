<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>1000 forms of bunnies &#8211; 1000 forms of bunnies</title>
<meta name="description" content="Victor's computer graphics playground.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">


<!-- Twitter Cards -->
<!-- original

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/images/wireframe-min.jpg">
  
<meta name="twitter:title" content="1000 forms of bunnies">
<meta name="twitter:description" content="Victor's computer graphics playground.">
<meta name="twitter:creator" content="@viclw17">

-->


<!-- Twitter Cards
clean and functional code
-->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/wireframe-min.jpg">
<meta name="twitter:title" content="1000 forms of bunnies">
<meta name="twitter:description" content="Victor's computer graphics playground.">
<meta name="twitter:creator" content="@viclw17">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="1000 forms of bunnies">
<meta property="og:description" content="Victor's computer graphics playground.">
<meta property="og:url" content="/">
<meta property="og:site_name" content="1000 forms of bunnies">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="1000 forms of bunnies Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




<style type="text/css">body {background-image:url(/images/shattered.png);}</style>


</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Victor Li photo" class="author-photo">
					<h4>Victor Li</h4>
					<!-- BR!!!-->
					<p>Technical Artist,<br /> CG Engineer,<br /> Mr. Curiosity.</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:viclw17@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/viclw17"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="https://github.com/viclw17"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				<li>
					<a href="https://ca.linkedin.com/in/viclw17"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
<!--
					<a href="https://linkedin.com/in/https://ca.linkedin.com/in/viclw17"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
-->
				</li>

				
				<li>
					<a href="https://instagram.com/viclw17"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
			</ul><!-- /.dl-submenu -->
		</li>

<li><a href="/posts/">All Posts</a></li>
<li><a href="/tags/">All Tags</a></li>

<!--
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
-->

		
	    
	    <li><a href="http://iamvictorli.com" target="_blank">Portfolio</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">

  <!-- /.image-credit -->
  <!--
  
 -->

  
    <div class="entry-image">
      <img src="/images/wireframe-min.jpg" alt="1000 forms of bunnies">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>1000 forms of bunnies</h1>
      <h2>Victor's computer graphics playground.</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->




<div id="main" role="main">
  
<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2016/05/01/MatCap-Shader-Showcase/" title="MatCap Shader Showcase"><img src="/images/matcap.png" alt="MatCap Shader Showcase"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-05-01T00:00:00-07:00"><a href="/2016/05/01/MatCap-Shader-Showcase/">May 01, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Victor Li">Victor Li</a></span></span>
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/05/01/MatCap-Shader-Showcase/" rel="bookmark" title="MatCap Shader Showcase" itemprop="url">MatCap Shader Showcase</a></h1>
    
  </header>
  <div class="entry-content">
    <p>MatCap (Material Capture) shader, for displaying objects with reflective materials with uniform surface colouring, like Zbrush or Mudbox can. It uses an image of a sphere as a view-space environment map. It’s very cheap, and looks great when the camera doesn’t rotate.</p>

<p><strong>Resources:</strong></p>

<ul>
  <li><a href="http://docs.pixologic.com/user-guide/materials-lights-rendering/materials/matcap/matcap-basics/">Explaination of application in Zbrush</a></li>
  <li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.29.1869&amp;rep=rep1&amp;type=pdf">Paper: The Lit Sphere: A Model for Capturing NPR Shading from Art</a></li>
</ul>

<p>This is a simple MatCap shader showcasing application I made by Unity:</p>

<ul>
  <li>Scroll mouse wheel to zoom;</li>
  <li>click and drag to change view angle;</li>
  <li>click top arrow to review the MatCap texture panel and try different effect.</li>
</ul>

<!-- <iframe src="/app/MatCap/MatCap.html" width="600" height="650" scrolling="no" frameborder="0" align="middle"> -->
<iframe src="/app/MatCap_webgl/index.html" width="600" height="650" scrolling="no" frameborder="0" align="middle">
</iframe>

<p><br /></p>

<p>This is the shader code of a typical MatCap shader. It is extremely straightforward on the theory and easy to implement.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Shader</span> <span class="s">"MatCap_Victor/Plain"</span>
<span class="p">{</span>
  <span class="n">Properties</span>
  <span class="p">{</span>
    <span class="n">_Color</span> <span class="p">(</span><span class="s">"Main Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_MatCap</span> <span class="p">(</span><span class="s">"MatCap (RGB)"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
  <span class="p">}</span>

  <span class="n">Subshader</span>
  <span class="p">{</span>
    <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>

    <span class="n">Pass</span>
    <span class="p">{</span>
      <span class="n">CGPROGRAM</span>
      	<span class="cp">#pragma vertex vert
</span>      	<span class="cp">#pragma fragment frag
</span>      	<span class="cp">#include "UnityCG.cginc"
</span>
      	<span class="k">struct</span> <span class="n">v2f</span>
      	<span class="p">{</span>
          <span class="n">float4</span> <span class="n">pos</span>	<span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
          <span class="n">float2</span> <span class="n">cap</span>	<span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
          <span class="n">float3</span> <span class="n">model_normal</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
          <span class="n">float3</span> <span class="n">world_normal</span> <span class="o">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
          <span class="n">float3</span> <span class="n">view_normal</span> <span class="o">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>
      	<span class="p">};</span>

        <span class="n">v2f</span> <span class="nf">vert</span> <span class="p">(</span><span class="n">appdata_base</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
          <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">mul</span> <span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>

          <span class="c1">// this is model normals
</span>          <span class="n">o</span><span class="p">.</span><span class="n">model_normal</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>

          <span class="c1">// transform normal vectors from model space to world space
</span>          <span class="n">float3</span> <span class="n">worldNorm</span> <span class="o">=</span>
            <span class="n">normalize</span><span class="p">(</span>
            	<span class="n">_World2Object</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xyz</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span>
            	<span class="n">_World2Object</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">xyz</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span>
            	<span class="n">_World2Object</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">xyz</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span>
            	<span class="p">);</span>

          <span class="c1">// this is world normals
</span>          <span class="n">o</span><span class="p">.</span><span class="n">world_normal</span> <span class="o">=</span> <span class="n">worldNorm</span><span class="p">;</span>

          <span class="c1">// transform normal vectors from world space to view space
</span>          <span class="n">float3</span> <span class="n">viewNorm</span> <span class="o">=</span> <span class="n">mul</span><span class="p">((</span><span class="n">float3x3</span><span class="p">)</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">worldNorm</span><span class="p">);</span>
          <span class="c1">// or use built-in UNITY_MATRIX_V
</span>
          <span class="c1">// this is viewspace normals
</span>          <span class="n">o</span><span class="p">.</span><span class="n">view_normal</span> <span class="o">=</span> <span class="n">viewNorm</span><span class="p">;</span>

          <span class="c1">// this is in the context of view space
</span>          <span class="c1">// get the coordinate on XY plane, ignore z coordinate
</span>          <span class="n">o</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">viewNorm</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span> <span class="c1">// clamp (-1,1) to (0, 1)
</span>
          <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">uniform</span> <span class="n">float4</span> <span class="n">_Color</span><span class="p">;</span>
        <span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">_MatCap</span><span class="p">;</span>

        <span class="n">float4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">COLOR</span>
        <span class="p">{</span>
          <span class="n">float4</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MatCap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">cap</span><span class="p">);</span>
          <span class="k">return</span>  <span class="n">_Color</span> <span class="o">*</span> <span class="n">mc</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="n">ENDCG</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">Fallback</span> <span class="s">"VertexLit"</span>
<span class="p">}</span></code></pre></figure>

<p>TBC</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2016/04/19/phong-shading-model-walkthrough/" title="Phong Shading Model Walkthrough"><img src="/images/phong.png" alt="Phong Shading Model Walkthrough"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-04-19T00:00:00-07:00"><a href="/2016/04/19/phong-shading-model-walkthrough/">April 19, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Victor Li">Victor Li</a></span></span>
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/04/19/phong-shading-model-walkthrough/" rel="bookmark" title="Phong Shading Model Walkthrough" itemprop="url">Phong Shading Model Walkthrough</a></h1>
    
  </header>
  <div class="entry-content">
    <p><a href="https://en.wikipedia.org/wiki/Phong_reflection_model">Phong shading model</a> is one of the most classic realistic shading models. It captures the basic features of a lit object using a very concise and straightforward theory. It matches people’s observation in daily life, and also easy to describe using math. Therefore, Phong shading model is always used as the base for other artistic shading effects to be built on.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/Phong_components_version_4.png" width="600" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Visual illustration of the Phong equation.
</figcaption>

<p>The theory is relatively simple. The final illumination of an object is <strong>a sum of ambient lighting and all the diffuse lighting &amp; specular  that caused by all the light sources</strong>. Ambient lighting and diffuse lighting are usually applied globally, and specular is for object that is not matte.</p>

<p><br />
 <img src=" https://upload.wikimedia.org/math/c/8/d/c8d48a83ae9c0a55afcf183b9b1ba585.png" width="400" height="400" style="display:block; margin:auto;" />
<br /></p>

<ul>
  <li><strong>ks</strong>, is specular reflection constant, the ratio of reflection of the specular term of incoming light,</li>
  <li><strong>kd</strong>, is diffuse reflection constant, the ratio of reflection of the diffuse term of incoming light (Lambertian reflectance),</li>
  <li><strong>ka</strong>, is ambient reflection constant, the ratio of reflection of the ambient term present in all points in the scene rendered,</li>
  <li><strong>α</strong>, is shininess constant, which is larger for surfaces that are smoother and more mirror-like. When this constant is large the specular highlight is small.</li>
  <li><strong>Lm</strong>, is the direction vector from the point on the surface toward each light source,</li>
  <li><strong>N</strong>, is the normal at this point on the surface,</li>
  <li><strong>Rm</strong>, is the direction of the reflected ray of light at this point on the surface,</li>
  <li><strong>V</strong>, is the direction pointing towards the viewer (such as a virtual camera).</li>
</ul>

<p><strong>Rm</strong> which is the reflected ray is essential for the specular effect. It is calculated with incoming ray vector, surface normal vector, and view direction vector using dot product.</p>

<p><br />
 <img src=" https://upload.wikimedia.org/math/7/3/4/7341beb3c269e92781c5013a8fb8d693.png" width="200" height="200" style="display:block; margin:auto;" />
<br /></p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/0/01/Blinn_Vectors.svg" width="300" height="300" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Vectors for calculating Phong (or Blinn–Phong) shading.
</figcaption>

<p>Here is the shader script for Phong shading using Cg:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Pass</span><span class="p">{</span>
  <span class="n">Tags</span><span class="p">{</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardBase"</span> <span class="p">}</span>
  <span class="c1">// pass for ambient light and first light source
</span>
  <span class="n">CGPROGRAM</span>

  <span class="cp">#pragma vertex vert  
</span>  <span class="cp">#pragma fragment frag
</span>
  <span class="cp">#include "UnityCG.cginc"
</span>  <span class="n">uniform</span> <span class="n">float4</span> <span class="n">_LightColor0</span><span class="p">;</span>
  <span class="c1">// color of light source (from "Lighting.cginc")
</span>
  <span class="c1">// User-specified properties
</span>  <span class="n">uniform</span> <span class="n">float4</span> <span class="n">_Color</span><span class="p">;</span>
  <span class="n">uniform</span> <span class="n">float4</span> <span class="n">_SpecColor</span><span class="p">;</span>
  <span class="n">uniform</span> <span class="kt">float</span> <span class="n">_Shininess</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">vertexInput</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">struct</span> <span class="n">vertexOutput</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">posWorld</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">normalDir</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="n">vertexOutput</span> <span class="nf">vert</span><span class="p">(</span><span class="n">vertexInput</span> <span class="n">input</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">vertexOutput</span> <span class="n">output</span><span class="p">;</span>

    <span class="n">float4x4</span> <span class="n">modelMatrix</span> <span class="o">=</span> <span class="n">_Object2World</span><span class="p">;</span>
    <span class="n">float4x4</span> <span class="n">modelMatrixInverse</span> <span class="o">=</span> <span class="n">_World2Object</span><span class="p">;</span>

    <span class="n">output</span><span class="p">.</span><span class="n">posWorld</span> <span class="o">=</span>
      <span class="n">mul</span><span class="p">(</span><span class="n">modelMatrix</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">output</span><span class="p">.</span><span class="n">normalDir</span> <span class="o">=</span>
      <span class="n">normalize</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">float4</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span> <span class="n">modelMatrixInverse</span><span class="p">).</span><span class="n">xyz</span><span class="p">);</span>
    <span class="n">output</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span>
      <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">vertexOutput</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">COLOR</span>
  <span class="p">{</span>
    <span class="n">float3</span> <span class="n">normalDirection</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">normalDir</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span> <span class="o">-</span> <span class="n">input</span><span class="p">.</span><span class="n">posWorld</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">lightDirection</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">attenuation</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span> <span class="o">==</span> <span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
    <span class="c1">// directional light?
</span>    <span class="p">{</span>
      <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// no attenuation
</span>      <span class="n">lightDirection</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="c1">// point or spot light
</span>    <span class="p">{</span>
      <span class="n">float3</span> <span class="n">vertexToLightSource</span> <span class="o">=</span> <span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">input</span><span class="p">.</span><span class="n">posWorld</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
      <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">vertexToLightSource</span><span class="p">);</span>
      <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">distance</span><span class="p">;</span> <span class="c1">// linear attenuation
</span>      <span class="n">lightDirection</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">vertexToLightSource</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">float3</span> <span class="n">ambientLighting</span> <span class="o">=</span>
      <span class="n">UNITY_LIGHTMODEL_AMBIENT</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">_Color</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>

    <span class="n">float3</span> <span class="n">diffuseReflection</span> <span class="o">=</span>
      <span class="n">attenuation</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">_Color</span><span class="p">.</span><span class="n">rgb</span>
      <span class="o">*</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalDirection</span><span class="p">,</span> <span class="n">lightDirection</span><span class="p">));</span>

    <span class="n">float3</span> <span class="n">specularReflection</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normalDirection</span><span class="p">,</span> <span class="n">lightDirection</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">// light source on the wrong side?
</span>    <span class="p">{</span>
      <span class="n">specularReflection</span> <span class="o">=</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// no specular reflection
</span>    <span class="p">}</span>
    <span class="k">else</span>
    <span class="c1">// light source on the right side
</span>    <span class="p">{</span>
      <span class="n">specularReflection</span> <span class="o">=</span>
        <span class="n">attenuation</span> <span class="o">*</span>
        <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span>
        <span class="n">_SpecColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span>
        <span class="n">pow</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">lightDirection</span><span class="p">,</span> <span class="n">normalDirection</span><span class="p">),</span><span class="n">viewDirection</span><span class="p">)),</span>
        <span class="n">_Shininess</span><span class="p">)</span>
        <span class="c1">// terminator optimization
</span>        <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">lightDirection</span><span class="p">,</span> <span class="n">normalDirection</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">float4</span> <span class="n">final</span> <span class="o">=</span> <span class="n">float4</span><span class="p">(</span>
    <span class="n">ambientLighting</span>   
    <span class="o">+</span>
    <span class="n">diffuseReflection</span>
    <span class="o">+</span>
    <span class="n">specularReflection</span>
    <span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">final</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ENDCG</span>
<span class="p">}</span> <span class="o">//</span><span class="n">END</span> <span class="n">PASS</span></code></pre></figure>

<p>If there are more than one light source, we can add one more pass for the additional lighting effects:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Pass</span><span class="p">{</span>
    <span class="n">Tags</span><span class="p">{</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardAdd"</span> <span class="p">}</span>
    <span class="c1">// pass for additional light sources
</span>    <span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>
    <span class="c1">// additive blending
</span>
    <span class="c1">//...
</span>    <span class="c1">// same with the first pass
</span>
    <span class="n">float4</span> <span class="n">final</span> <span class="o">=</span> <span class="n">float4</span><span class="p">(</span>
    <span class="n">diffuseReflection</span>
    <span class="o">+</span>
    <span class="n">specularReflection</span>
    <span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="c1">// no need for ambient lighting any more!
</span>
    <span class="c1">//...
</span>    <span class="c1">// same with the first pass
</span>
<span class="p">}</span> <span class="o">//</span><span class="n">END</span> <span class="n">PASS</span></code></pre></figure>

<p>This is the testing effect:</p>

<p><img src="/images/Phong/ambient.PNG" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Ambient only.
</figcaption>

<p><img src="/images/Phong/diffuse.PNG" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Diffuse only.
</figcaption>

<p><img src="/images/Phong/specular.PNG" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Specular only.
</figcaption>

<p><img src="/images/Phong/phong.PNG" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">
Final.
</figcaption>

<p><em>However, <strong>if statement</strong> is not optimal in shader. This is because shader is running on GPU and GPU has a highly parallel structure. I will document the optimization for the shader in future post.</em></p>

<p>V</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-04-10T00:00:00-07:00"><a href="/2016/04/10/specular-shading-optimization/">April 10, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Victor Li">Victor Li</a></span></span>
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/04/10/specular-shading-optimization/" rel="bookmark" title="Specular Shading Optimization" itemprop="url">Specular Shading Optimization</a></h1>
    
  </header>
  <div class="entry-content">
    <p>When learning and practicing shader programming for Unity, I found the <a href="https://en.wikibooks.org/wiki/Cg_Programming/Unity">Cg Wiki</a> website extremely benevolent on getting a well-rounded understanding of how to shade an object step by step. Apart from the magic configuration parts(Shader Properties/Passes/Tags etc.) of a typical Unity shader, the main function-related part of the shader only lies between <em>CGPROGRAM</em> and <em>ENDCG</em>. According to my practice, I believe <a href="https://en.wikibooks.org/wiki/Cg_Programming/Unity">Cg Wiki</a> and <a href="http://docs.unity3d.com/Manual/SL-Reference.html">Unity Shader Reference</a> can cover almost all the basic tricks of Unity shader programming. ;)</p>

<p>However, when I went through the <a href="https://en.wikibooks.org/wiki/Cg_Programming/Unity/Specular_Highlights">Specular Highlights</a> tutorial trying to achieve a <a href="https://en.wikipedia.org/wiki/Phong_shading">Phong Shading</a> effect from scratch, I found the code snippet that the tutorial provided has some artifacts.</p>

<p><img src="http://www.itchy-animation.co.uk/tutorials/01-intro-01.jpg" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Different areas of a typical shaded sphere. <br /> Note that the terminator line should be a soft gradient. </figcaption>

<p>After implementing the shading algorithm, the visual looks pretty promising. But when I rotate the light source or move the view direction I notice the terminator could sometimes becomes a sharp boundary between lit and shadow areas:</p>

<p><img src="/images/specular1.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Artifact of the specular shader.<br />(The terminator line gets unnatural at some angles.)</figcaption>
<p><br /></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">float3</span> <span class="n">specularReflection</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normalDirection</span><span class="p">,</span> <span class="n">lightDirection</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">){</span>
  <span class="c1">// light source on the wrong side.
</span>  <span class="n">specularReflection</span> <span class="o">=</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// no specular reflection.
</span><span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="c1">// light source on the right side
</span>  <span class="n">specularReflection</span> <span class="o">=</span>
    <span class="n">attenuation</span> <span class="o">*</span>
    <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span>
    <span class="n">_SpecColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span>
    <span class="n">pow</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">lightDirection</span><span class="p">,</span> <span class="n">normalDirection</span><span class="p">),</span> <span class="n">viewDirection</span><span class="p">)),</span>
    <span class="n">_Shininess</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">return</span> <span class="n">float4</span><span class="p">(</span>
  <span class="n">ambientLighting</span> <span class="o">+</span>
  <span class="n">diffuseReflection</span> <span class="o">+</span>
  <span class="n">specularReflection</span><span class="p">,</span>
  <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>The specular is calculated by the dot product of the reflect vector and the view direction vector. However, this angle can be larger than 90 degrees. According to how dot product is calculated,</p>

<p><img src="https://upload.wikimedia.org/math/3/e/5/3e530da12e51ca0056ed3ef061b79312.png" width="200" height="200" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;"></figcaption>
<p><img src="http://mathworld.wolfram.com/images/eps-gif/Cos_600.gif" width="300" height="300" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;"></figcaption>
<p>When the angle between view direction and lighting direction is <strong>larger than 90 degrees</strong>, the cosine of it will be negative, and the dot product is also going to be negative.</p>

<p>Color is in the type of float4/half4/fixed4 in Cg and can not has negative elements. The negative values are simply treated as pitch black and cause this “hard terminator” artifact.</p>

<p>One of the ways to fix it is to multiply the final color result with the same dot product result again.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">specularReflection</span> <span class="o">=</span> <span class="n">attenuation</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">_SpecColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span>
  <span class="n">pow</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">lightDirection</span><span class="p">,</span> <span class="n">normalDirection</span><span class="p">),</span> <span class="n">viewDirection</span><span class="p">)),</span>
  <span class="n">_Shininess</span><span class="p">);</span>
  <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">lightDirection</span><span class="p">,</span> <span class="n">normalDirection</span><span class="p">);</span> <span class="o">//</span> <span class="n">fixed</span><span class="o">!</span></code></pre></figure>

<p>Since the length of direction vectors is always 1, so this can get rid off the negative values. And this is the optimized result:</p>

<p><img src="/images/specular2.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;"></figcaption>

<p>Now the terminator is smooth! :D</p>

<!-- The reflect vector is calculated using the Cg function -reflect()-. This function is the implement of the function  -->

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2016/03/29/low-poly-water/" title="Low Poly Water"><img src="/images/bg_blue.png" alt="Low Poly Water"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-03-29T00:00:00-07:00"><a href="/2016/03/29/low-poly-water/">March 29, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Victor Li">Victor Li</a></span></span>
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/03/29/low-poly-water/" rel="bookmark" title="Low Poly Water" itemprop="url">Low Poly Water</a></h1>
    
  </header>
  <div class="entry-content">
    <p>My first water shader exploration in unity started with trying to <strong>make the water surface waving</strong>. This required mesh manipulation through shader or scripts. By playing around it, I got to know more about what other effects I can try, and here is a little side-achievement – a nice low poly water effect:</p>

<p><img src="/images/low_poly_water1.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Low poly water mesh with unity standard specular material.</figcaption>

<p>To change the shape of a plane mesh, my first idea was to play some tricks in vertex shader – how about <strong>moving vertexes along their corresponding normal directions and changing the move distance randomly according to a displacement texture</strong> (e.g. a noise texture)? Here is the code of my vertex shader:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">v2f</span> <span class="nf">vert</span><span class="p">(</span><span class="n">appdata_full</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
  <span class="n">o</span><span class="p">.</span><span class="n">uv_DispTex</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">,</span> <span class="n">_DispTex</span><span class="p">);</span>
  <span class="n">o</span><span class="p">.</span><span class="n">uv_DispTex</span> <span class="o">+=</span> <span class="n">float2</span><span class="p">(</span><span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">_WavingSpeed</span><span class="p">;</span>
  <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span> <span class="o">+=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span> <span class="o">*</span> <span class="n">tex2Dlod</span><span class="p">(</span><span class="n">_DispTex</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">uv_DispTex</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                  <span class="o">*</span> <span class="n">_Displacement</span><span class="p">;</span>
  <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This is going to implement deformation on GPU level and the effect will come with the material assigned. And then this is the effect: (For debugging purpose I visualized the vertex normals):</p>

<p><img src="/images/low_poly_fig0.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Low poly water mesh assigned with the vertex shader above. (Green lines are vertex normals)</figcaption>

<p>IT IS something I want! However, as the gif shows, the drawing of the mesh is affected by the shader but the normals are not modified, which makes it impossible to achieve a beautiful low ploy flat shading style (e.g. image below). (Although the shader I wrote was unlit, since the normals are not even moved or rotated, it won’t make any difference with lighting model implemented.)</p>

<p><img src="/images/flat_shading.png" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">W/ and w/o flat shading.</figcaption>

<p>Then I decided to go for scripting approach. This is my script to move the vertex and randomize the movement using Sine and Perlin Noise functions. This is my script:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">public</span> <span class="n">class</span> <span class="n">WaterPlane</span> <span class="o">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="n">public</span> <span class="kt">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">public</span> <span class="kt">float</span> <span class="n">sinSpeedX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">public</span> <span class="kt">float</span> <span class="n">sinSpeedZ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">public</span> <span class="kt">float</span> <span class="n">perlinSpeedX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">public</span> <span class="kt">float</span> <span class="n">perlinSpeedZ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">private</span> <span class="n">Vector3</span><span class="p">[]</span> <span class="n">baseVertices</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">bool</span> <span class="n">recalculateNormals</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="n">public</span> <span class="n">bool</span> <span class="n">isSin</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">public</span> <span class="n">bool</span> <span class="n">isPerlin</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="n">Mesh</span> <span class="n">mesh</span><span class="p">;</span>
  <span class="n">Vector3</span><span class="p">[]</span> <span class="n">vertices</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">MeshFilter</span><span class="o">&gt;</span><span class="p">().</span><span class="n">mesh</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">baseVertices</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
        <span class="n">baseVertices</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">vertices</span><span class="p">;</span>

    <span class="n">vertices</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Vector3</span><span class="p">[</span><span class="n">baseVertices</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">Update</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vertices</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">Vector3</span> <span class="n">vertex</span> <span class="o">=</span> <span class="n">baseVertices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">isSin</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">isPerlin</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">sinSpeedX</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">Mathf</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">sinSpeedZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isPerlin</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">isSin</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PerlinNoise</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">perlinSpeedX</span><span class="p">,</span>
                                        <span class="n">vertex</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">perlinSpeedZ</span><span class="p">)</span><span class="o">*</span> <span class="n">scale</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isPerlin</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">isSin</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">vertex</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PerlinNoise</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">perlinSpeedX</span><span class="p">,</span>
                                        <span class="n">vertex</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">perlinSpeedZ</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">Mathf</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">sinSpeedX</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">Mathf</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">vertex</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">sinSpeedZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">mesh</span><span class="p">.</span><span class="n">MarkDynamic</span><span class="p">();</span>
      <span class="n">mesh</span><span class="p">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">;</span>
      <span class="n">mesh</span><span class="p">.</span><span class="n">RecalculateBounds</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">recalculateNormals</span><span class="p">)</span>
    		<span class="n">mesh</span><span class="p">.</span><span class="n">RecalculateNormals</span> <span class="p">();</span>

    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Since it was only on CPU level, we can apply material with any shader we want, which is great. The effect was like this:</p>

<p><img src="/images/low_poly_fig2.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Low poly water mesh assigned with the script above. (Green lines are vertex normals)</figcaption>
<!-- <img src="/images/low_poly_fig3.gif" width="400" height="400" style="display:block; margin:auto;">
<figcaption style="text-align: center;">Low poly water mesh assigned with the script above. (Green lines are vertex normals)</figcaption> -->

<p>Note that the line <strong>mesh.RecalculateNormals ();</strong> is very important. If we remove it, the vertexes are moved but the normals are not updated and they will keep pointing upward, so the shading will look like smooth. And we will lost the nice flat shading:</p>

<p><img src="/images/low_poly_fig1.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">W/o mesh.RecalculateNormals (); (Green lines are vertex normals, )</figcaption>

<p>However, this effect will be eventually useful when I want to implement the real water surface effect. I will show that in Water Shader Exploration Part-2.</p>

<p>Now I can simply use the powerful build-in Standard shader and tweak the smoothness and the transparency to achieve a nice low poly water effect. :D</p>

<p><img src="/images/low_poly_water2.gif" width="400" height="400" style="display:block; margin:auto;" />
<!-- <figcaption style="text-align: center;">W/o mesh.RecalculateNormals (); (Green lines are vertex normals, )</figcaption> --></p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2016/03/28/water-shader-exploration-part-1/" title="Water Shader Exploration Part-1"><img src="/images/water.jpg" alt="Water Shader Exploration Part-1"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-03-28T00:00:00-07:00"><a href="/2016/03/28/water-shader-exploration-part-1/">March 28, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Victor Li">Victor Li</a></span></span>
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/03/28/water-shader-exploration-part-1/" rel="bookmark" title="Water Shader Exploration Part-1" itemprop="url">Water Shader Exploration Part-1</a></h1>
    
  </header>
  <div class="entry-content">
    <h2 id="intro">Intro</h2>

<p>First try of water effect in Unity.</p>

<p>One of my current VR projects needs a nice and light water shader. I have been working on it for a while and keep iterating the the overall effect. Here is the water effect I have achieved so far, however it’s still far away from perfect simulation:</p>

<p><img src="/images/water0.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Final work w/o transparency.</figcaption>

<p>Water effect has been always a complicated topic in shading especially for runtime scenario. As the most usual material in our daily life, water has lots of visual features that we are very familiar with. However, all these features also got lots of physics and lighting formulas involved which are interacting with each other.</p>

<p>I started with thinking about the most typical physical and lighting features that came into mind and got my hand dirty immediately to achieve as much as I can. Here is my <strong>checklist</strong>:</p>

<ul>
  <li>Blue-ish color.</li>
  <li>Waving surface.
    <ul>
      <li>Using script to deform a plane mesh, <strong>OR</strong></li>
      <li>Manipulating vertex in vertex shader.</li>
    </ul>
  </li>
  <li>Ripple.
    <ul>
      <li>Texture &amp; Normal Map</li>
      <li>UV Scrolling</li>
    </ul>
  </li>
  <li>Reflection.
    <ul>
      <li>Specular lighting model</li>
      <li>Cubemap</li>
    </ul>
  </li>
  <li>Transparency.</li>
  <li>Refraction. (no idea…)</li>
</ul>

<p>I firstly wrote a script to move the vertex of a plane mesh according to sine wave, and added <a href="http://docs.unity3d.com/ScriptReference/Mathf.PerlinNoise.html">Perlin Noise</a> function to add some randomness. Then I started to write my water shader to turn this waving plane into a water like surface with all the interesting lighting attributes that I can think about. In Part-2 I will go through my exploration in details.</p>

<!-- <img src="/images/water1.gif" width="400" height="400" style="display:block; margin:auto;">
<figcaption style="text-align: center;">Final work w/o transparency.</figcaption> -->

<p><img src="/images/water2.gif" width="400" height="400" style="display:block; margin:auto;" /></p>
<figcaption style="text-align: center;">Final work w/ transparency and faint tint and BUNNY!</figcaption>

<p>The current water effect is enough for the scope of my project and it’s light to implement and has decent visual features. However, this is just a very very high-level implement using Unity and for simple environment. Also, there are a lot of features that are very important in water, like refraction, that I haven’t implemented. I will keep working on my exploration on this topic in the future.</p>

<p>P.S. My ultimate goal about water simulation could be <strong>Low-Level GPU-Based Volumetric Fluid Simulation</strong>. Hopefully I’m able to give a shot one day. Video here just for admiring and future reference. :)</p>

<!-- 
<iframe src="https://player.vimeo.com/video/87050516?autoplay=1&loop=1&title=0&byline=0&portrait=0" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
<p><a href="https://vimeo.com/87050516">PIC/FLIP Simulator Dam Break Test- Final Render</a> from <a href="https://vimeo.com/user3522674">Yining Karl Li</a> on <a href="https://vimeo.com">Vimeo</a>.</p>
-->

<p>(TBC)</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    

    
    

    
      <li><a href="/page2/">2</a></li>
    

    
    
      <li><a href="/page2/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Victor Li.

  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll.</a>
  <!-- Theme  <a href="https://github.com/mmistakes/hpstr-jekyll-theme">available on Github.</a> -->
</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75504070-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>




</body>
</html>
